<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Game Mathematician</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #00e5ff;
      --primary-hover: #00b8d4;
      --primary-glow: rgba(0, 229, 255, 0.15);
      --primary-deep: rgba(0, 229, 255, 0.06);
      --analysis: #bb86fc;
      --analysis-hover: #9c64fb;
      --analysis-glow: rgba(187, 134, 252, 0.12);
      --logic: #ffc107;
      --logic-hover: #ffab00;
      --logic-glow: rgba(255, 193, 7, 0.12);
      --bg: #06070b;
      --bg-card: #0c0d14;
      --bg-elevated: #12141e;
      --border: rgba(0, 229, 255, 0.08);
      --border-active: rgba(0, 229, 255, 0.25);
      --text: #e8eaed;
      --text-dim: #6b7280;
      --text-muted: #3f4553;
      --success: #00e676;
      --success-glow: rgba(0, 230, 118, 0.1);
      --danger: #ff4444;
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      background-image:
        radial-gradient(ellipse 60% 40% at 50% 0%, rgba(0,229,255,0.04), transparent),
        radial-gradient(ellipse 40% 30% at 80% 100%, rgba(187,134,252,0.03), transparent);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: var(--text);
      overflow: hidden;
      padding: 16px;
    }

    #chatInner {
      width: 100%;
      max-width: 920px;
      height: 94vh;
      max-height: 920px;
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 0 80px -20px rgba(0,229,255,0.06), 0 30px 60px -20px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€â”€ Header â”€â”€â”€ */
    .header {
      padding: 18px 28px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(0,229,255,0.03) 0%, transparent 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left { display: flex; align-items: center; gap: 14px; }

    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--primary), var(--analysis));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: 700;
      box-shadow: 0 0 20px rgba(0,229,255,0.2);
    }

    h2 {
      font-family: 'Outfit', sans-serif;
      font-size: 1.15rem;
      font-weight: 700;
      color: #fff;
      letter-spacing: -0.02em;
    }

    h2 span {
      font-weight: 400;
      color: var(--text-dim);
      font-size: 0.85rem;
      margin-left: 6px;
    }

    #gameActiveIndicator {
      display: none;
      align-items: center;
      gap: 7px;
      padding: 5px 14px;
      background: var(--success-glow);
      border: 1px solid rgba(0,230,118,0.3);
      border-radius: 20px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--success);
      cursor: pointer;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      transition: all 0.2s;
    }
    #gameActiveIndicator:hover { background: rgba(0,230,118,0.15); }
    #gameActiveIndicator.active { display: flex; }
    #gameActiveIndicator::before {
      content: '';
      width: 6px; height: 6px;
      background: var(--success);
      border-radius: 50%;
      box-shadow: 0 0 8px var(--success);
      animation: livePulse 2s ease infinite;
    }
    @keyframes livePulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

    /* â”€â”€â”€ Mode Bar â”€â”€â”€ */
    #adjustmentModeBar {
      display: none;
      padding: 10px 28px;
      background: var(--primary-deep);
      border-bottom: 1px solid var(--border);
      align-items: center;
      justify-content: center;
      gap: 14px;
      font-size: 0.8rem;
      color: var(--text-dim);
    }
    #adjustmentModeBar.active { display: flex; }

    .type-label {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
      font-size: 0.7rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    .type-label.analysis { background: var(--analysis-glow); color: var(--analysis); border: 1px solid rgba(187,134,252,0.2); }
    .type-label.logic { background: var(--logic-glow); color: var(--logic); border: 1px solid rgba(255,193,7,0.2); }

    /* â”€â”€â”€ Messages â”€â”€â”€ */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 28px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 4px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border-active); border-radius: 4px; }

    .message {
      max-width: 78%;
      padding: 12px 18px;
      border-radius: var(--radius);
      font-size: 0.9rem;
      line-height: 1.65;
      word-wrap: break-word;
      animation: msgIn 0.25s ease;
    }
    @keyframes msgIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

    .user {
      align-self: flex-end;
      background: linear-gradient(135deg, rgba(0,229,255,0.12), rgba(0,229,255,0.06));
      color: var(--text);
      border: 1px solid rgba(0,229,255,0.15);
      border-bottom-right-radius: 4px;
    }

    .bot {
      align-self: flex-start;
      background: var(--bg-elevated);
      color: var(--text);
      border-bottom-left-radius: 4px;
      border: 1px solid var(--border);
    }
    .bot.highlight {
      border-color: rgba(187,134,252,0.3);
      background: linear-gradient(135deg, rgba(187,134,252,0.06), rgba(187,134,252,0.02));
    }

    /* â”€â”€â”€ Input Area â”€â”€â”€ */
    .input-area {
      padding: 16px 28px 20px;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
    }

    #waitMessage {
      display: none;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding: 10px 14px;
      background: var(--primary-deep);
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
      color: var(--text-dim);
    }
    .pulse-dots { display: flex; gap: 4px; }
    .pulse-dot {
      width: 5px; height: 5px;
      background: var(--primary);
      border-radius: 50%;
      animation: pd 1.4s ease infinite;
    }
    .pulse-dot:nth-child(2) { animation-delay: 0.2s; }
    .pulse-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pd { 0%,80%,100%{opacity:0.3;transform:scale(0.8);} 40%{opacity:1;transform:scale(1.2);} }

    /* â”€â”€â”€ Progress Bars â”€â”€â”€ */
    .progress-box { display: none; margin-bottom: 12px; }
    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.72rem;
      color: var(--text-dim);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .progress-track {
      width: 100%; height: 4px;
      background: rgba(255,255,255,0.04);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.4s ease;
      width: 0%;
    }
    #progressContainer .progress-fill {
      background: linear-gradient(90deg, var(--primary), var(--analysis));
      box-shadow: 0 0 12px rgba(0,229,255,0.3);
    }
    #analysisProgress .progress-fill {
      background: linear-gradient(90deg, var(--analysis), #e040fb);
      box-shadow: 0 0 12px rgba(187,134,252,0.3);
    }

    /* â”€â”€â”€ Links â”€â”€â”€ */
    #links { display: none; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .link-button {
      flex: 1;
      padding: 9px 14px;
      text-align: center;
      border-radius: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      font-weight: 500;
      text-decoration: none;
      border: 1px solid;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-width: 110px;
      transition: all 0.2s;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .link-button:hover { transform: translateY(-1px); }
    .link-button.play {
      background: var(--success-glow);
      color: var(--success);
      border-color: rgba(0,230,118,0.25);
    }
    .link-button.play:hover { background: rgba(0,230,118,0.15); }
    .link-button.download {
      background: var(--primary-deep);
      color: var(--primary);
      border-color: rgba(0,229,255,0.2);
    }
    .link-button.download:hover { background: rgba(0,229,255,0.1); }
    .link-button.dashboard {
      background: var(--analysis-glow);
      color: var(--analysis);
      border-color: rgba(187,134,252,0.2);
      display: none;
    }
    .link-button.dashboard.show { display: inline-flex; }
    .link-button.dashboard:hover { background: rgba(187,134,252,0.15); }

    #refreshLink {
      display: none;
      padding: 7px 12px;
      border-radius: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.72rem;
      font-weight: 500;
      text-decoration: none;
      border: 1px solid rgba(255,193,7,0.25);
      background: var(--logic-glow);
      color: var(--logic);
      cursor: pointer;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    #refreshLink.show { display: inline-flex; }
    #refreshLink:hover { background: rgba(255,193,7,0.15); }

    /* â”€â”€â”€ Textarea â”€â”€â”€ */
    textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--text);
      font-family: 'Outfit', sans-serif;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 72px;
      max-height: 180px;
      margin-bottom: 10px;
      transition: border-color 0.2s;
    }
    textarea:focus { outline: none; border-color: var(--border-active); background: rgba(255,255,255,0.03); }
    textarea::placeholder { color: var(--text-muted); }

    /* â”€â”€â”€ Buttons â”€â”€â”€ */
    .button-container { display: flex; gap: 8px; }

    button {
      padding: 10px 22px;
      border-radius: 10px;
      border: none;
      font-family: 'Outfit', sans-serif;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      flex: 1;
      transition: all 0.2s;
      letter-spacing: -0.01em;
    }
    button:disabled { opacity: 0.35; cursor: not-allowed; }
    button:not(:disabled):hover { transform: translateY(-1px); }

    #sendButton {
      background: var(--primary);
      color: var(--bg);
      box-shadow: 0 0 20px rgba(0,229,255,0.15);
    }
    #sendButton:not(:disabled):hover { box-shadow: 0 0 30px rgba(0,229,255,0.25); }

    #analysisButton {
      background: var(--analysis);
      color: var(--bg);
      display: none;
      box-shadow: 0 0 20px rgba(187,134,252,0.15);
    }
    #analysisButton:not(:disabled):hover { box-shadow: 0 0 30px rgba(187,134,252,0.25); }

    #logicButton {
      background: var(--logic);
      color: var(--bg);
      display: none;
      box-shadow: 0 0 20px rgba(255,193,7,0.15);
    }
    #logicButton:not(:disabled):hover { box-shadow: 0 0 30px rgba(255,193,7,0.25); }

    .button-container.adjustment-mode #sendButton { display: none; }
    .button-container.adjustment-mode #analysisButton,
    .button-container.adjustment-mode #logicButton { display: flex; }

    .button-hint {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 8px;
      text-align: center;
      letter-spacing: 0.03em;
    }
  </style>
</head>
<body>
  <div id="chatInner">
    <div class="header">
      <div class="header-left">
        <div class="logo-icon">âˆ‘</div>
        <h2>Game Mathematician <span>Â· AI-Powered</span></h2>
      </div>
      <div id="gameActiveIndicator" onclick="openGamePreview()">LIVE</div>
    </div>
    <div id="adjustmentModeBar">
      <span>Game loaded â€”</span>
      <div class="type-label analysis">ðŸ“Š Analysis</div>
      <div class="type-label logic">âš™ Logic</div>
    </div>
    <div id="messages"></div>
    <div class="input-area">
      <div id="waitMessage">
        <div class="pulse-dots"><div class="pulse-dot"></div><div class="pulse-dot"></div><div class="pulse-dot"></div></div>
        <span id="waitText">Processing...</span>
      </div>

      <div class="progress-box" id="progressContainer">
        <div class="progress-header"><span id="progressLabel">Building</span><span id="percentText">0%</span></div>
        <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="progress-box" id="analysisProgress">
        <div class="progress-header"><span>Analyzing</span><span id="analysisPercent">0%</span></div>
        <div class="progress-track"><div class="progress-fill" id="analysisFill"></div></div>
      </div>

      <div id="links">
        <a href="#" id="playLink" class="link-button play" target="_blank">â–¶ Play</a>
        <a href="#" id="downloadLink" class="link-button download" download>â†“ Download</a>
        <a href="#" id="dashboardLink" class="link-button dashboard" target="_blank">ðŸ“Š Analysis Dashboard</a>
        <a href="#" id="refreshLink" onclick="refreshGame(event)">â†» Refresh</a>
      </div>

      <textarea id="messageInput" placeholder="Describe your game concept..."></textarea>
      <div class="button-container normal-mode" id="buttonContainer">
        <button id="sendButton" onclick="sendMessage()"><span>Create Game</span></button>
        <button id="analysisButton" onclick="sendAnalysis()"><span>ðŸ“Š Run Analysis</span></button>
        <button id="logicButton" onclick="sendLogicAdjustment()"><span>âš™ Edit Logic</span></button>
      </div>
      <div class="button-hint">â†µ enter to send Â· â‡§â†µ new line</div>
    </div>
  </div>

  <script>
    var url = "https://jaafar.ngrok.app";
    var session_id = Math.random().toString(36).substring(2, 15);
    var gameExists = false;
    var currentGameLink = null;
    var gameWindow = null;
    var lastAdjustmentComplete = false;
    var lastConfirmationShown = false;
    var analysisRunning = false;

    function addMsg(text, sender, hl) {
      var d = document.getElementById("messages");
      var m = document.createElement("div");
      m.className = "message " + sender;
      if (hl) m.classList.add("highlight");
      m.textContent = text;
      d.appendChild(m);
      d.scrollTop = d.scrollHeight;
    }

    function setBtns(off) {
      document.getElementById("sendButton").disabled = off;
      document.getElementById("analysisButton").disabled = off;
      document.getElementById("logicButton").disabled = off;
    }

    function setAdjMode(on) {
      document.getElementById("buttonContainer").className = on ? "button-container adjustment-mode" : "button-container normal-mode";
      document.getElementById("adjustmentModeBar").classList[on ? "add" : "remove"]("active");
    }

    function updateGameIndicator(exists, link) {
      gameExists = exists; currentGameLink = link;
      document.getElementById("gameActiveIndicator").classList[exists ? "add" : "remove"]("active");
      if (exists) setAdjMode(true);
    }

    function openGamePreview() { if (currentGameLink) window.open(url + currentGameLink, '_blank'); }
    function refreshGame(e) { e.preventDefault(); if (currentGameLink) window.open(url + currentGameLink + "?t=" + Date.now(), '_blank'); }

    function sendMessage() {
      var inp = document.getElementById("messageInput");
      var msg = inp.value.trim();
      if (!msg || document.getElementById("sendButton").disabled) return;
      addMsg(msg, "user");
      inp.value = "";
      document.getElementById("waitMessage").style.display = "flex";
      setBtns(true);
      lastAdjustmentComplete = false;
      lastConfirmationShown = false;
      gameWindow = null;
      document.getElementById("dashboardLink").classList.remove("show");

      fetch(url + "/receive_message", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({message: msg, session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        if (d.status === "True") addMsg(d.reply, "bot");
        else addMsg("Error: " + d.reply, "bot");
        document.getElementById("waitMessage").style.display = "none";
      }).catch(function(){
        addMsg("Connection error.", "bot");
        document.getElementById("waitMessage").style.display = "none";
        setBtns(false);
      });
    }

    function sendAnalysis() {
      if (document.getElementById("analysisButton").disabled) return;
      if (analysisRunning) return;
      addMsg("ðŸ“Š Running mathematical analysis...", "user");
      setBtns(true);
      analysisRunning = true;
      var ap = document.getElementById("analysisProgress");
      ap.style.display = "block";
      document.getElementById("analysisFill").style.width = "0%";
      document.getElementById("analysisPercent").textContent = "0%";

      fetch(url + "/analyze_game", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        if (d.status === "True") {
          addMsg(d.reply, "bot", true);
          pollAnalysis();
        } else {
          addMsg("Error: " + d.reply, "bot");
          analysisRunning = false;
          ap.style.display = "none";
          setBtns(false);
        }
      }).catch(function(){
        addMsg("Connection error.", "bot");
        analysisRunning = false;
        ap.style.display = "none";
        setBtns(false);
      });
    }

    function pollAnalysis() {
      if (!analysisRunning) return;
      fetch(url + "/get_analysis_result", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        var pct = d.progress || 0;
        document.getElementById("analysisFill").style.width = pct + "%";
        document.getElementById("analysisPercent").textContent = pct + "%";

        if (d.status === "success") {
          analysisRunning = false;
          document.getElementById("analysisFill").style.width = "100%";
          document.getElementById("analysisPercent").textContent = "100%";
          setBtns(false);
          addMsg("âœ… " + d.message, "bot", true);
          if (d.dashboard_path) {
            var dl = document.getElementById("dashboardLink");
            dl.href = url + d.dashboard_path;
            dl.classList.add("show");
            addMsg("ðŸ“Š Analysis dashboard ready â€” click the button below to open", "bot", true);
          }
        } else {
          setTimeout(pollAnalysis, 2000);
        }
      }).catch(function(){
        setTimeout(pollAnalysis, 3000);
      });
    }

    function sendLogicAdjustment() {
      var inp = document.getElementById("messageInput");
      var msg = inp.value.trim();
      if (!msg || document.getElementById("logicButton").disabled) return;
      addMsg("âš™ " + msg, "user");
      inp.value = "";
      document.getElementById("waitMessage").style.display = "flex";
      setBtns(true);
      fetch(url + "/adjust_logic", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({message: msg, session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        if (d.status === "True") { addMsg(d.reply, "bot", true); lastAdjustmentComplete = false; }
        else addMsg("Error: " + d.reply, "bot");
        document.getElementById("waitMessage").style.display = "none";
      }).catch(function(){
        addMsg("Connection error.", "bot");
        document.getElementById("waitMessage").style.display = "none";
        setBtns(false);
      });
    }

    function checkStatus() {
      fetch(url + "/get_status", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        var pct = d.process_percent;
        var pc = document.getElementById("progressContainer");
        var pf = document.getElementById("progressFill");
        var lk = document.getElementById("links");
        var pt = document.getElementById("percentText");
        var rl = document.getElementById("refreshLink");
        var isAdj = d.is_adjustment;

        if (pct > 0 && pct < 100) {
          pc.style.display = "block";
          lk.style.display = "none";
          pf.style.width = pct + "%";
          pt.innerText = pct + "%";
          if (!analysisRunning) setBtns(true);
        } else if (pct === 100) {
          pf.style.width = "100%";
          pt.innerText = "100%";
          pc.style.display = "block";
          lk.style.display = "flex";
          document.getElementById("playLink").href = url + d.game_link;
          document.getElementById("downloadLink").href = url + d.download_link;
          updateGameIndicator(true, d.game_link);
          if (isAdj || d.should_refresh) rl.classList.add("show");
          if (d.confirmation_message && !lastConfirmationShown) {
            lastConfirmationShown = true;
            addMsg("âœ… " + d.confirmation_message, "bot", true);
          }
          if (!lastAdjustmentComplete && !analysisRunning && d.game_link && d.game_link.indexOf(session_id) !== -1) {
            lastAdjustmentComplete = true;
            var gu = url + d.game_link + "?t=" + Date.now();
            if (gameWindow && !gameWindow.closed) { gameWindow.location.href = gu; gameWindow.focus(); }
            else gameWindow = window.open(gu, 'gameWindow_' + session_id);
          }
          if (!analysisRunning) setBtns(false);
        } else {
          pc.style.display = "none";
          lk.style.display = "none";
          pf.style.width = "0%";
          lastAdjustmentComplete = false;
          lastConfirmationShown = false;
        }
      }).catch(function(){});
    }

    function checkGameExists() {
      fetch(url + "/check_game_exists", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        if (d.exists) updateGameIndicator(true, d.game_link);
      }).catch(function(){});
    }

    document.getElementById("messageInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (gameExists) sendLogicAdjustment();
        else sendMessage();
      }
    });

    checkGameExists();
    setInterval(checkStatus, 1000);
  </script>
</body>
</html>
