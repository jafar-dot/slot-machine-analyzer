<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Slot Machine Developer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --primary-light: rgba(99, 102, 241, 0.1);
      --analysis: #06b6d4;
      --analysis-hover: #0891b2;
      --analysis-light: rgba(6, 182, 212, 0.1);
      --logic: #f59e0b;
      --logic-hover: #d97706;
      --logic-light: rgba(245, 158, 11, 0.1);
      --bg-dark: #0a0a0f;
      --card-bg: rgba(17, 17, 27, 0.85);
      --card-border: rgba(99, 102, 241, 0.15);
      --text-main: #e4e4e7;
      --text-muted: #a1a1aa;
      --success: #10b981;
      --success-bg: rgba(16, 185, 129, 0.1);
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif; background: var(--bg-dark);
      background-image: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(99,102,241,0.15), transparent);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; color: var(--text-main); overflow: hidden; padding: 20px;
    }
    #chatInner {
      width: 100%; max-width: 900px; height: 92vh; max-height: 900px;
      background: var(--card-bg); backdrop-filter: blur(24px); border-radius: 24px;
      border: 1px solid var(--card-border); box-shadow: 0 20px 60px -15px rgba(0,0,0,0.7);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .header {
      padding: 20px 36px; border-bottom: 1px solid var(--card-border);
      background: rgba(17,17,27,0.6); display: flex; justify-content: space-between; align-items: center;
    }
    h2 { font-size: 1.3rem; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 12px; }
    .ai-badge {
      display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px;
      background: var(--primary-light); border: 1px solid var(--primary); border-radius: 20px;
      font-size: 0.75rem; font-weight: 600; color: var(--primary); text-transform: uppercase;
    }
    #gameActiveIndicator {
      display: none; align-items: center; gap: 8px; padding: 6px 14px;
      background: var(--success-bg); border: 1px solid var(--success); border-radius: 20px;
      font-size: 0.75rem; font-weight: 600; color: var(--success); cursor: pointer;
    }
    #gameActiveIndicator.active { display: flex; }
    #adjustmentModeBar {
      display: none; padding: 12px 36px; background: var(--primary-light);
      border-bottom: 1px solid var(--primary); align-items: center; justify-content: center;
      gap: 16px; font-size: 0.9rem;
    }
    #adjustmentModeBar.active { display: flex; }
    .type-label {
      display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px;
      font-weight: 500; font-size: 0.8rem;
    }
    .type-label.analysis { background: var(--analysis-light); color: var(--analysis); }
    .type-label.logic { background: var(--logic-light); color: var(--logic); }
    #messages {
      flex: 1; overflow-y: auto; padding: 24px 36px; display: flex;
      flex-direction: column; gap: 16px; scroll-behavior: smooth;
    }
    .message {
      max-width: 75%; padding: 14px 20px; border-radius: 16px;
      font-size: 0.95rem; line-height: 1.6; word-wrap: break-word;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .user {
      align-self: flex-end; background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: white; border-bottom-right-radius: 4px;
    }
    .bot {
      align-self: flex-start; background: rgba(39,39,52,0.6); color: var(--text-main);
      border-bottom-left-radius: 4px; border: 1px solid rgba(99,102,241,0.1);
    }
    .bot.highlight { border-color: var(--analysis); background: var(--analysis-light); }
    .input-area { padding: 20px 36px 24px; background: rgba(17,17,27,0.8); border-top: 1px solid var(--card-border); }
    #waitMessage {
      display: none; align-items: center; gap: 10px; margin-bottom: 14px;
      padding: 12px 16px; background: var(--primary-light); border-radius: 10px; border: 1px solid var(--card-border);
    }
    .pulse-dots { display: flex; gap: 4px; }
    .pulse-dot { width:6px; height:6px; background:var(--primary); border-radius:50%; animation: pd 1.4s ease infinite; }
    .pulse-dot:nth-child(2) { animation-delay:0.2s; }
    .pulse-dot:nth-child(3) { animation-delay:0.4s; }
    @keyframes pd { 0%,80%,100%{opacity:0.3;transform:scale(0.8);} 40%{opacity:1;transform:scale(1.2);} }

    /* Progress bars */
    .progress-box { display: none; margin-bottom: 14px; }
    .progress-header { display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.85rem; color:var(--text-muted); }
    .progress-track { width:100%; height:6px; background:rgba(99,102,241,0.1); border-radius:10px; overflow:hidden; }
    .progress-fill { height:100%; border-radius:10px; transition:width 0.3s ease; width:0%; }
    #progressContainer .progress-fill { background: linear-gradient(90deg, var(--primary), var(--primary-hover)); }
    #analysisProgress .progress-fill { background: linear-gradient(90deg, var(--analysis), var(--analysis-hover)); }

    /* Links */
    #links { display:none; gap:10px; margin-bottom:14px; flex-wrap:wrap; }
    .link-button {
      flex:1; padding:10px 16px; text-align:center; border-radius:10px; font-size:0.9rem;
      font-weight:500; text-decoration:none; border:1px solid; display:inline-flex;
      align-items:center; justify-content:center; gap:8px; min-width:130px; transition:all 0.2s;
    }
    .link-button.play { background:var(--success-bg); color:var(--success); border-color:var(--success); }
    .link-button.download { background:var(--primary-light); color:var(--primary); border-color:var(--primary); }
    .link-button.dashboard { background:var(--analysis-light); color:var(--analysis); border-color:var(--analysis); display:none; }
    .link-button.dashboard.show { display:inline-flex; }
    #refreshLink { display:none; padding:8px 14px; border-radius:8px; font-size:0.85rem; font-weight:500;
      text-decoration:none; border:1px solid var(--warning); background:var(--warning-bg); color:var(--warning); cursor:pointer; }
    #refreshLink.show { display:inline-flex; }

    .button-container { display:flex; gap:10px; }
    textarea {
      width:100%; padding:14px 18px; border-radius:14px; border:1.5px solid var(--card-border);
      background:rgba(39,39,52,0.4); color:var(--text-main); font-size:0.95rem; resize:vertical;
      min-height:80px; max-height:200px; font-family:inherit; margin-bottom:12px;
    }
    textarea:focus { outline:none; border-color:var(--primary); }
    button {
      padding:12px 28px; border-radius:12px; border:none; font-size:0.95rem; font-weight:600;
      cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; flex:1;
      transition: all 0.2s;
    }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    #sendButton { background:linear-gradient(135deg,var(--primary),var(--primary-hover)); color:white; }
    #analysisButton { background:linear-gradient(135deg,var(--analysis),var(--analysis-hover)); color:white; display:none; }
    #logicButton { background:linear-gradient(135deg,var(--logic),var(--logic-hover)); color:white; display:none; }
    .button-container.adjustment-mode #sendButton { display:none; }
    .button-container.adjustment-mode #analysisButton,
    .button-container.adjustment-mode #logicButton { display:flex; }
    .button-hint { font-size:0.75rem; color:var(--text-muted); margin-top:8px; text-align:center; }
  </style>
</head>
<body>
  <div id="chatInner">
    <div class="header">
      <h2>AI Slot Machine <span class="ai-badge">Powered by AI</span></h2>
      <div id="gameActiveIndicator" onclick="openGamePreview()">Game Active - Click to View</div>
    </div>
    <div id="adjustmentModeBar">
      <span>üéÆ Game exists ‚Äî</span>
      <div class="type-label analysis">üìä Analysis</div>
      <div class="type-label logic">‚öôÔ∏è Logic</div>
    </div>
    <div id="messages"></div>
    <div class="input-area">
      <div id="waitMessage">
        <div class="pulse-dots"><div class="pulse-dot"></div><div class="pulse-dot"></div><div class="pulse-dot"></div></div>
        <span id="waitText">AI is processing...</span>
      </div>

      <!-- Game creation/logic progress -->
      <div class="progress-box" id="progressContainer">
        <div class="progress-header"><span id="progressLabel">Building game</span><span id="percentText">0%</span></div>
        <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <!-- Analysis progress (separate!) -->
      <div class="progress-box" id="analysisProgress">
        <div class="progress-header"><span>üìä Analyzing paytable</span><span id="analysisPercent">0%</span></div>
        <div class="progress-track"><div class="progress-fill" id="analysisFill"></div></div>
      </div>

      <div id="links">
        <a href="#" id="playLink" class="link-button play" target="_blank">‚ñ∂Ô∏è Play</a>
        <a href="#" id="downloadLink" class="link-button download" download>‚¨áÔ∏è Download</a>
        <a href="#" id="dashboardLink" class="link-button dashboard" target="_blank">üìä Simulation Dashboard</a>
        <a href="#" id="refreshLink" onclick="refreshGame(event)">üîÑ Refresh</a>
      </div>

      <textarea id="messageInput" placeholder="Describe your game..."></textarea>
      <div class="button-container normal-mode" id="buttonContainer">
        <button id="sendButton" onclick="sendMessage()"><span>üöÄ Create Game</span></button>
        <button id="analysisButton" onclick="sendAnalysis()"><span>üìä Analysis</span></button>
        <button id="logicButton" onclick="sendLogicAdjustment()"><span>‚öôÔ∏è Game Logic</span></button>
      </div>
      <div class="button-hint">üí° Enter to send, Shift+Enter for new line</div>
    </div>
  </div>

  <script>
    var url = "https://jaafar.ngrok.app";
    var session_id = Math.random().toString(36).substring(2, 15);
    var gameExists = false;
    var currentGameLink = null;
    var gameWindow = null;
    var lastAdjustmentComplete = false;
    var lastConfirmationShown = false;
    var analysisRunning = false;

    function addMsg(text, sender, hl) {
      var d = document.getElementById("messages");
      var m = document.createElement("div");
      m.className = "message " + sender;
      if (hl) m.classList.add("highlight");
      m.textContent = text;
      d.appendChild(m);
      d.scrollTop = d.scrollHeight;
    }

    function setBtns(off) {
      document.getElementById("sendButton").disabled = off;
      document.getElementById("analysisButton").disabled = off;
      document.getElementById("logicButton").disabled = off;
    }

    function setAdjMode(on) {
      document.getElementById("buttonContainer").className = on ? "button-container adjustment-mode" : "button-container normal-mode";
      document.getElementById("adjustmentModeBar").classList[on ? "add" : "remove"]("active");
    }

    function updateGameIndicator(exists, link) {
      gameExists = exists; currentGameLink = link;
      document.getElementById("gameActiveIndicator").classList[exists ? "add" : "remove"]("active");
      if (exists) setAdjMode(true);
    }

    function openGamePreview() { if (currentGameLink) window.open(url + currentGameLink, '_blank'); }
    function refreshGame(e) { e.preventDefault(); if (currentGameLink) window.open(url + currentGameLink + "?t=" + Date.now(), '_blank'); }

    // ‚îÄ‚îÄ‚îÄ Create Game ‚îÄ‚îÄ‚îÄ
    function sendMessage() {
      var inp = document.getElementById("messageInput");
      var msg = inp.value.trim();
      if (!msg || document.getElementById("sendButton").disabled) return;
      addMsg(msg, "user");
      inp.value = "";
      document.getElementById("waitMessage").style.display = "flex";
      setBtns(true);
      fetch(url + "/receive_message", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({message: msg, session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        if (d.status === "True") addMsg(d.reply, "bot");
        else addMsg("Error: " + d.reply, "bot");
        document.getElementById("waitMessage").style.display = "none";
      }).catch(function(){
        addMsg("Connection error.", "bot");
        document.getElementById("waitMessage").style.display = "none";
        setBtns(false);
      });
    }

    // ‚îÄ‚îÄ‚îÄ Analysis ‚Äî completely separate flow ‚îÄ‚îÄ‚îÄ
    function sendAnalysis() {
      if (document.getElementById("analysisButton").disabled) return;
      if (analysisRunning) return;

      addMsg("üìä ANALYSIS: Verify paytable & build simulation dashboard", "user");
      setBtns(true);
      analysisRunning = true;

      // Show analysis progress bar
      var ap = document.getElementById("analysisProgress");
      ap.style.display = "block";
      document.getElementById("analysisFill").style.width = "0%";
      document.getElementById("analysisPercent").textContent = "0%";

      fetch(url + "/analyze_game", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        if (d.status === "True") {
          addMsg(d.reply, "bot", true);
          pollAnalysis();
        } else {
          addMsg("Error: " + d.reply, "bot");
          analysisRunning = false;
          ap.style.display = "none";
          setBtns(false);
        }
      }).catch(function(){
        addMsg("Connection error.", "bot");
        analysisRunning = false;
        ap.style.display = "none";
        setBtns(false);
      });
    }

    function pollAnalysis() {
      if (!analysisRunning) return;
      fetch(url + "/get_analysis_result", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        // Update progress bar
        var pct = d.progress || 0;
        document.getElementById("analysisFill").style.width = pct + "%";
        document.getElementById("analysisPercent").textContent = pct + "%";

        if (d.status === "success") {
          // DONE
          analysisRunning = false;
          document.getElementById("analysisFill").style.width = "100%";
          document.getElementById("analysisPercent").textContent = "100%";
          setBtns(false);

          addMsg("‚úÖ " + d.message, "bot", true);

          if (d.dashboard_path) {
            var dl = document.getElementById("dashboardLink");
            dl.href = url + d.dashboard_path;
            dl.classList.add("show");
            addMsg("üìä Click 'Simulation Dashboard' button to open it", "bot", true);
          }
        } else {
          // Still pending
          setTimeout(pollAnalysis, 2000);
        }
      }).catch(function(){
        setTimeout(pollAnalysis, 3000);
      });
    }

    // ‚îÄ‚îÄ‚îÄ Game Logic ‚îÄ‚îÄ‚îÄ
    function sendLogicAdjustment() {
      var inp = document.getElementById("messageInput");
      var msg = inp.value.trim();
      if (!msg || document.getElementById("logicButton").disabled) return;
      addMsg("‚öôÔ∏è LOGIC: " + msg, "user");
      inp.value = "";
      document.getElementById("waitMessage").style.display = "flex";
      setBtns(true);
      fetch(url + "/adjust_logic", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({message: msg, session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        if (d.status === "True") { addMsg(d.reply, "bot", true); lastAdjustmentComplete = false; }
        else addMsg("Error: " + d.reply, "bot");
        document.getElementById("waitMessage").style.display = "none";
      }).catch(function(){
        addMsg("Connection error.", "bot");
        document.getElementById("waitMessage").style.display = "none";
        setBtns(false);
      });
    }

    // ‚îÄ‚îÄ‚îÄ Status polling (ONLY for game creation and logic adjustments) ‚îÄ‚îÄ‚îÄ
    function checkStatus() {
      fetch(url + "/get_status", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        var pct = d.process_percent;
        var pc = document.getElementById("progressContainer");
        var pf = document.getElementById("progressFill");
        var lk = document.getElementById("links");
        var pt = document.getElementById("percentText");
        var rl = document.getElementById("refreshLink");
        var isAdj = d.is_adjustment;

        if (pct > 0 && pct < 100) {
          pc.style.display = "block";
          lk.style.display = "none";
          pf.style.width = pct + "%";
          pt.innerText = pct + "%";
          if (!analysisRunning) setBtns(true);

        } else if (pct === 100) {
          pf.style.width = "100%";
          pt.innerText = "100%";
          pc.style.display = "block";
          lk.style.display = "flex";

          document.getElementById("playLink").href = url + d.game_link;
          document.getElementById("downloadLink").href = url + d.download_link;
          updateGameIndicator(true, d.game_link);

          if (isAdj || d.should_refresh) rl.classList.add("show");

          if (d.confirmation_message && !lastConfirmationShown) {
            lastConfirmationShown = true;
            addMsg("‚úÖ " + d.confirmation_message, "bot", true);
          }

          // Auto-open game window ONLY for game creation and logic adj, NOT analysis
          if (!lastAdjustmentComplete && !analysisRunning) {
            lastAdjustmentComplete = true;
            var gu = url + d.game_link + "?t=" + Date.now();
            if (gameWindow && !gameWindow.closed) { gameWindow.location.href = gu; gameWindow.focus(); }
            else gameWindow = window.open(gu, 'slotGameWindow');
          }

          if (!analysisRunning) setBtns(false);

        } else {
          pc.style.display = "none";
          lk.style.display = "none";
          pf.style.width = "0%";
          lastAdjustmentComplete = false;
          lastConfirmationShown = false;
        }
      }).catch(function(){});
    }

    function checkGameExists() {
      fetch(url + "/check_game_exists", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({session_id: session_id})
      }).then(function(r){return r.json();}).then(function(d){
        if (d.exists) updateGameIndicator(true, d.game_link);
      }).catch(function(){});
    }

    document.getElementById("messageInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (gameExists) sendLogicAdjustment();
        else sendMessage();
      }
    });

    checkGameExists();
    setInterval(checkStatus, 1000);
  </script>
</body>
</html>
